
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Reading Posts from Jiali Duan.">
      
      
      
        <link rel="canonical" href="https://davidsonic.github.io/Reading_Posts/detections/faster-rcnn/">
      
      <link rel="icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.9">
    
    
      
        <title>Faster-RCNN - Reading Posts</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2b4465f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#faster-rcnn" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Reading Posts" class="md-header__button md-logo" aria-label="Reading Posts" data-md-component="logo">
      
  <img src="../../img/logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reading Posts
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Faster-RCNN
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/davidsonic/Reading_Posts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Reading Posts" class="md-nav__button md-logo" aria-label="Reading Posts" data-md-component="logo">
      
  <img src="../../img/logo_white.svg" alt="logo">

    </a>
    Reading Posts
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/davidsonic/Reading_Posts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Detections
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Detections" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Detections
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Faster-RCNN
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Faster-RCNN
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-faster-rcnn" class="md-nav__link">
    Overview of Faster-RCNN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codebase-hierarchy" class="md-nav__link">
    Codebase Hierarchy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-analysis" class="md-nav__link">
    Code Analysis
  </a>
  
    <nav class="md-nav" aria-label="Code Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-point" class="md-nav__link">
    Entry Point
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpn" class="md-nav__link">
    RPN
  </a>
  
    <nav class="md-nav" aria-label="RPN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anchor-template-generation" class="md-nav__link">
    Anchor Template Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpn-head" class="md-nav__link">
    RPN Head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#region-proposal-network" class="md-nav__link">
    Region Proposal Network
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roi-heads" class="md-nav__link">
    ROI Heads
  </a>
  
    <nav class="md-nav" aria-label="ROI Heads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#assign-targets-to-proposals" class="md-nav__link">
    Assign Targets to Proposals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../yolo-series/" class="md-nav__link">
        YOLO-Series
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          SelfSupervised
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="SelfSupervised" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          SelfSupervised
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../selfsupervised/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Multimodal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Multimodal" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Multimodal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../multimodal/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          VideoRecog
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="VideoRecog" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          VideoRecog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../video/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Embodied-QA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Embodied-QA" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Embodied-QA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../embody/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          3d-vision
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="3d-vision" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          3d-vision
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3dvision/recon/" class="md-nav__link">
        Reconstruction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../3dvision/view-synthesis/" class="md-nav__link">
        Novel-View-Synthesis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-of-faster-rcnn" class="md-nav__link">
    Overview of Faster-RCNN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codebase-hierarchy" class="md-nav__link">
    Codebase Hierarchy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-analysis" class="md-nav__link">
    Code Analysis
  </a>
  
    <nav class="md-nav" aria-label="Code Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-point" class="md-nav__link">
    Entry Point
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpn" class="md-nav__link">
    RPN
  </a>
  
    <nav class="md-nav" aria-label="RPN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#anchor-template-generation" class="md-nav__link">
    Anchor Template Generation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpn-head" class="md-nav__link">
    RPN Head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#region-proposal-network" class="md-nav__link">
    Region Proposal Network
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roi-heads" class="md-nav__link">
    ROI Heads
  </a>
  
    <nav class="md-nav" aria-label="ROI Heads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#assign-targets-to-proposals" class="md-nav__link">
    Assign Targets to Proposals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="faster-rcnn">Faster-RCNN</h1>
<h2 id="overview-of-faster-rcnn">Overview of Faster-RCNN</h2>
<p><img alt="Faster-RCNN framework" src="../img/fasterRCNN.png" /></p>
<h2 id="codebase-hierarchy">Codebase Hierarchy</h2>
<ul>
<li>backbone: feature extraction</li>
<li>network_files: Fast-RCNN &amp; RPN</li>
<li>train_utils: cocotools etc</li>
<li>my_dataset.py: dataset class for VOC</li>
<li>train_mobilenet.py: MobileNetV2 as backbone</li>
<li>train_resnet50_fpn.py: resnet50 + FPN as backbone</li>
<li>train_multi_GPU.py: multi-gpu training</li>
<li>predict.py: inference script</li>
<li>validation.py: generate record_mAP.txt on COCO</li>
<li>pascal_voc_classes.json: pascal labels</li>
</ul>
<h2 id="code-analysis">Code Analysis</h2>
<h3 id="entry-point">Entry Point</h3>
<p>Same as the framework plot, there're three major components for Faster-RCNN: backbone, rpn, roi_heads. </p>
<ul>
<li>backbone: takes image as input and output features</li>
<li>rpn: takes features and targets as input and is responsible for anchor generation, matching anchor to targets, sampling, computing losses (e.g., objectness, regressions), generating proposals etc. </li>
<li>roi_heads: takes features, proposals, image sizes, targets as input and generate detections, compute losses. Its function overlaps with those of rpn. The difference is it refines the input proposals and compute losses for different classes rather than objectness.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FasterRCNNBase</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for Generalized R-CNN.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        backbone (nn.Module):</span>
<span class="sd">        rpn (nn.Module):</span>
<span class="sd">        roi_heads (nn.Module): takes the features + the proposals from the RPN and computes</span>
<span class="sd">            detections / masks from it.</span>
<span class="sd">        transform (nn.Module): performs the data transformation from the inputs to feed into</span>
<span class="sd">            the model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backbone</span><span class="p">,</span> <span class="n">rpn</span><span class="p">,</span> <span class="n">roi_heads</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FasterRCNNBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">backbone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpn</span> <span class="o">=</span> <span class="n">rpn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roi_heads</span> <span class="o">=</span> <span class="n">roi_heads</span>
        <span class="c1"># used only on torchscript mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_warned</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">unused</span>
    <span class="k">def</span> <span class="nf">eager_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">detections</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># type: (List[Tensor], Optional[List[Dict[str, Tensor]]]) -&gt; Tuple[Dict[str, Tensor], List[Dict[str, Tensor]]]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            images (list[Tensor]): images to be processed</span>
<span class="sd">            targets (list[Dict[Tensor]]): ground-truth boxes present in the image (optional)</span>

<span class="sd">        Returns:</span>
<span class="sd">            result (list[BoxList] or dict[Tensor]): the output from the model.</span>
<span class="sd">                During training, it returns a dict[Tensor] which contains the losses.</span>
<span class="sd">                During testing, it returns list[BoxList] contains additional fields</span>
<span class="sd">                like `scores`, `labels` and `mask` (for Mask R-CNN models).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;In training mode, targets should be passed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>         <span class="c1"># 进一步判断传入的target的boxes参数是否符合规定</span>
                <span class="n">boxes</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected target boxes to be a tensor&quot;</span>
                                         <span class="s2">&quot;of shape [N, 4], got </span><span class="si">{:}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                          <span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected target boxes to be of type &quot;</span>
                                     <span class="s2">&quot;Tensor, got </span><span class="si">{:}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">boxes</span><span class="p">)))</span>

        <span class="n">original_image_sizes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># 防止输入的是个一维向量</span>
            <span class="n">original_image_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># original_image_sizes = [img.shape[-2:] for img in images]</span>

        <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>  <span class="c1"># 对图像进行预处理</span>

        <span class="c1"># print(images.tensors.shape)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">tensors</span><span class="p">)</span>  <span class="c1"># 将图像输入backbone得到特征图</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>  <span class="c1"># 若只在一层特征层上预测，将feature放入有序字典中，并编号为‘0’</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">features</span><span class="p">)])</span>  <span class="c1"># 若在多层特征层上预测，传入的就是一个有序字典</span>

        <span class="c1"># 将特征层以及标注target信息传入rpn中</span>
        <span class="c1"># proposals: List[Tensor], Tensor_shape: [num_proposals, 4],</span>
        <span class="c1"># 每个proposals是绝对坐标，且为(x1, y1, x2, y2)格式</span>
        <span class="n">proposals</span><span class="p">,</span> <span class="n">proposal_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpn</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

        <span class="c1"># 将rpn生成的数据以及标注target信息传入fast rcnn后半部分</span>
        <span class="n">detections</span><span class="p">,</span> <span class="n">detector_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roi_heads</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">proposals</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">image_sizes</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

        <span class="c1"># 对网络的预测结果进行后处理（主要将bboxes还原到原图像尺度上）</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">image_sizes</span><span class="p">,</span> <span class="n">original_image_sizes</span><span class="p">)</span>

        <span class="n">losses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">detector_losses</span><span class="p">)</span>
        <span class="n">losses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proposal_losses</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">losses</span>
        <span class="k">return</span> <span class="n">detections</span>
</code></pre></div>
<h3 id="rpn">RPN</h3>
<p>RPN module will first generate anchors and cls predictions, anchor offsets. The proposals will then be constructed based on 
the offsets and anchor templates. After filtering, the proposals
and targets will be used to compute RPN loss. </p>
<h4 id="anchor-template-generation">Anchor Template Generation</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 遍历每个预测特征层的grid_size，strides和cell_anchors</span>
<span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">base_anchors</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid_sizes</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">cell_anchors</span><span class="p">):</span>
    <span class="n">grid_height</span><span class="p">,</span> <span class="n">grid_width</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">stride_height</span><span class="p">,</span> <span class="n">stride_width</span> <span class="o">=</span> <span class="n">stride</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">base_anchors</span><span class="o">.</span><span class="n">device</span>

    <span class="c1"># For output anchor, compute [x_center, y_center, x_center, y_center]</span>
    <span class="c1"># shape: [grid_width] 对应原图上的x坐标(列)</span>
    <span class="n">shifts_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride_width</span>
    <span class="c1"># shape: [grid_height] 对应原图上的y坐标(行)</span>
    <span class="n">shifts_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_height</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">stride_height</span>

    <span class="c1"># 计算预测特征矩阵上每个点对应原图上的坐标(anchors模板的坐标偏移量)</span>
    <span class="c1"># torch.meshgrid函数分别传入行坐标和列坐标，生成网格行坐标矩阵和网格列坐标矩阵</span>
    <span class="c1"># shape: [grid_height, grid_width]</span>
    <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">shifts_y</span><span class="p">,</span> <span class="n">shifts_x</span><span class="p">)</span>
    <span class="n">shift_x</span> <span class="o">=</span> <span class="n">shift_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shift_y</span> <span class="o">=</span> <span class="n">shift_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 计算anchors坐标(xmin, ymin, xmax, ymax)在原图上的坐标偏移量</span>
    <span class="c1"># shape: [grid_width*grid_height, 4]</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span> <span class="n">shift_y</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># For every (base anchor, output anchor) pair,</span>
    <span class="c1"># offset each zero-centered base anchor by the center of the output anchor.</span>
    <span class="c1"># 将anchors模板与原图上的坐标偏移量相加得到原图上所有anchors的坐标信息(shape不同时会使用广播机制)</span>
    <span class="n">shifts_anchor</span> <span class="o">=</span> <span class="n">shifts</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">base_anchors</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shifts_anchor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</code></pre></div>
<h4 id="rpn-head">RPN Head</h4>
<p>RPNHead performs sliding-window scanning on the feature maps by using a 3x3 convolutional kernel. The output is cls_logits and
box_pred, both of which are implemented with 1x1 convolution. </p>
<h4 id="region-proposal-network">Region Proposal Network</h4>
<p>This module is a wrapper that chains the following functions: </p>
<ul>
<li>assign_targets_to_anchors: find the matching gt for each anchor and categorize the anchors into positives/negatives, bacground and ignorables. </li>
<li>filter_proposals: filter out boxes that are too small. Perform NMS, select post_nms_top_n based on probability. </li>
<li>compute_loss: calculate rpn loss, including class loss, box regression loss. </li>
<li>forward: chain up mentioned functions and return boxes, losses to the main entry file. </li>
</ul>
<div class="highlight"><pre><span></span><code>Arguments:
        anchor_generator (AnchorGenerator): module that generates the anchors for a set of feature
            maps.
        head (nn.Module): module that computes the objectness and regression deltas
        fg_iou_thresh (float): minimum IoU between the anchor and the GT box so that they can be
            considered as positive during training of the RPN.
        bg_iou_thresh (float): maximum IoU between the anchor and the GT box so that they can be
            considered as negative during training of the RPN.
        batch_size_per_image (int): number of anchors that are sampled during training of the RPN
            for computing the loss
        positive_fraction (float): proportion of positive anchors in a mini-batch during training
            of the RPN
        pre_nms_top_n (Dict[str]): number of proposals to keep before applying NMS. It should
            contain two fields: training and testing, to allow for different values depending
            on training or evaluation
        post_nms_top_n (Dict[str]): number of proposals to keep after applying NMS. It should
            contain two fields: training and testing, to allow for different values depending
            on training or evaluation
        nms_thresh (float): NMS threshold used for postprocessing the RPN proposals
</code></pre></div>
<blockquote>
<p>How is matching performed for proposals?</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># 遍历每张图像的anchors和targets</span>
<span class="k">for</span> <span class="n">anchors_per_image</span><span class="p">,</span> <span class="n">targets_per_image</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="n">gt_boxes</span> <span class="o">=</span> <span class="n">targets_per_image</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">gt_boxes</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">anchors_per_image</span><span class="o">.</span><span class="n">device</span>
        <span class="n">matched_gt_boxes_per_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">anchors_per_image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels_per_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">anchors_per_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 计算anchors与真实bbox的iou信息</span>
        <span class="c1"># set to self.box_similarity when https://github.com/pytorch/pytorch/issues/27495 lands</span>
        <span class="n">match_quality_matrix</span> <span class="o">=</span> <span class="n">box_ops</span><span class="o">.</span><span class="n">box_iou</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">,</span> <span class="n">anchors_per_image</span><span class="p">)</span>
        <span class="c1"># 计算每个anchors与gt匹配iou最大的索引（如果iou&lt;0.3索引置为-1，0.3&lt;iou&lt;0.7索引为-2）</span>
        <span class="n">matched_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="p">(</span><span class="n">match_quality_matrix</span><span class="p">)</span>
        <span class="c1"># get the targets corresponding GT for each proposal</span>
        <span class="c1"># NB: need to clamp the indices because we can have a single</span>
        <span class="c1"># GT in the image, and matched_idxs can be -2, which goes</span>
        <span class="c1"># out of bounds</span>
        <span class="c1"># 这里使用clamp设置下限0是为了方便取每个anchors对应的gt_boxes信息</span>
        <span class="c1"># 负样本和舍弃的样本都是负值，所以为了防止越界直接置为0</span>
        <span class="c1"># 因为后面是通过labels_per_image变量来记录正样本位置的，</span>
        <span class="c1"># 所以负样本和舍弃的样本对应的gt_boxes信息并没有什么意义，</span>
        <span class="c1"># 反正计算目标边界框回归损失时只会用到正样本。</span>
        <span class="n">matched_gt_boxes_per_image</span> <span class="o">=</span> <span class="n">gt_boxes</span><span class="p">[</span><span class="n">matched_idxs</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># 记录所有anchors匹配后的标签(正样本处标记为1，负样本处标记为0，丢弃样本处标记为-2)</span>
        <span class="n">labels_per_image</span> <span class="o">=</span> <span class="n">matched_idxs</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">labels_per_image</span> <span class="o">=</span> <span class="n">labels_per_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># background (negative examples)</span>
        <span class="n">bg_indices</span> <span class="o">=</span> <span class="n">matched_idxs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="o">.</span><span class="n">BELOW_LOW_THRESHOLD</span>  <span class="c1"># -1</span>
        <span class="n">labels_per_image</span><span class="p">[</span><span class="n">bg_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># discard indices that are between thresholds</span>
        <span class="n">inds_to_discard</span> <span class="o">=</span> <span class="n">matched_idxs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="o">.</span><span class="n">BETWEEN_THRESHOLDS</span>  <span class="c1"># -2</span>
        <span class="n">labels_per_image</span><span class="p">[</span><span class="n">inds_to_discard</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_per_image</span><span class="p">)</span>
    <span class="n">matched_gt_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_gt_boxes_per_image</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>How is the loss computed for RPN?</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">计算RPN损失，包括类别损失（前景与背景），bbox regression损失</span>
<span class="sd">Arguments:</span>
<span class="sd">    objectness (Tensor)：预测的前景概率</span>
<span class="sd">    pred_bbox_deltas (Tensor)：预测的bbox regression</span>
<span class="sd">    labels (List[Tensor])：真实的标签 1, 0, -1（batch中每一张图片的labels对应List的一个元素中）</span>
<span class="sd">    regression_targets (List[Tensor])：真实的bbox regression</span>

<span class="sd">Returns:</span>
<span class="sd">    objectness_loss (Tensor) : 类别损失</span>
<span class="sd">    box_loss (Tensor)：边界框回归损失</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># 按照给定的batch_size_per_image, positive_fraction选择正负样本</span>
<span class="n">sampled_pos_inds</span><span class="p">,</span> <span class="n">sampled_neg_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_bg_sampler</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="c1"># 将一个batch中的所有正负样本List(Tensor)分别拼接在一起，并获取非零位置的索引</span>
<span class="c1"># sampled_pos_inds = torch.nonzero(torch.cat(sampled_pos_inds, dim=0)).squeeze(1)</span>
<span class="n">sampled_pos_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sampled_pos_inds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># sampled_neg_inds = torch.nonzero(torch.cat(sampled_neg_inds, dim=0)).squeeze(1)</span>
<span class="n">sampled_neg_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sampled_neg_inds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># 将所有正负样本索引拼接在一起</span>
<span class="n">sampled_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">sampled_pos_inds</span><span class="p">,</span> <span class="n">sampled_neg_inds</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">objectness</span> <span class="o">=</span> <span class="n">objectness</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">regression_targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">regression_targets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># 计算边界框回归损失</span>
<span class="n">box_loss</span> <span class="o">=</span> <span class="n">det_utils</span><span class="o">.</span><span class="n">smooth_l1_loss</span><span class="p">(</span>
    <span class="n">pred_bbox_deltas</span><span class="p">[</span><span class="n">sampled_pos_inds</span><span class="p">],</span>
    <span class="n">regression_targets</span><span class="p">[</span><span class="n">sampled_pos_inds</span><span class="p">],</span>
    <span class="n">beta</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span>
    <span class="n">size_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sampled_inds</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>

<span class="c1"># 计算目标预测概率损失</span>
<span class="n">objectness_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span>
    <span class="n">objectness</span><span class="p">[</span><span class="n">sampled_inds</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">sampled_inds</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<h3 id="roi-heads">ROI Heads</h3>
<p>ROI head has certain overlapping functions with RPN heads, as two-stage indicates. Instead of generating offsets for the anchor templates, the ROI head refines the proposal from the last stage by predicting class labels and offsets. The supervision signals come from matching targets to proposals. </p>
<h4 id="assign-targets-to-proposals">Assign Targets to Proposals</h4>
<blockquote>
<p>Prepare supervisions for roi heads ?</p>
</blockquote>
<div class="highlight"><pre><span></span><code> <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">为每个proposal匹配对应的gt_box，并划分到正负样本中</span>
<span class="sd">Args:</span>
<span class="sd">    proposals:</span>
<span class="sd">    gt_boxes:</span>
<span class="sd">    gt_labels:</span>

<span class="sd">Returns:</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="n">matched_idxs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># 遍历每张图像的proposals, gt_boxes, gt_labels信息</span>
<span class="k">for</span> <span class="n">proposals_in_image</span><span class="p">,</span> <span class="n">gt_boxes_in_image</span><span class="p">,</span> <span class="n">gt_labels_in_image</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">gt_boxes</span><span class="p">,</span> <span class="n">gt_labels</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">gt_boxes_in_image</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 该张图像中没有gt框，为背景</span>
        <span class="c1"># background image</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">proposals_in_image</span><span class="o">.</span><span class="n">device</span>
        <span class="n">clamped_matched_idxs_in_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">proposals_in_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">labels_in_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="n">proposals_in_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#  set to self.box_similarity when https://github.com/pytorch/pytorch/issues/27495 lands</span>
        <span class="c1"># 计算proposal与每个gt_box的iou重合度</span>
        <span class="n">match_quality_matrix</span> <span class="o">=</span> <span class="n">box_ops</span><span class="o">.</span><span class="n">box_iou</span><span class="p">(</span><span class="n">gt_boxes_in_image</span><span class="p">,</span> <span class="n">proposals_in_image</span><span class="p">)</span>

        <span class="c1"># 计算proposal与每个gt_box匹配的iou最大值，并记录索引，</span>
        <span class="c1"># iou &lt; low_threshold索引值为 -1， low_threshold &lt;= iou &lt; high_threshold索引值为 -2</span>
        <span class="n">matched_idxs_in_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="p">(</span><span class="n">match_quality_matrix</span><span class="p">)</span>

        <span class="c1"># 限制最小值，防止匹配标签时出现越界的情况</span>
        <span class="c1"># 注意-1, -2对应的gt索引会调整到0,获取的标签类别为第0个gt的类别（实际上并不是）,后续会进一步处理</span>
        <span class="n">clamped_matched_idxs_in_image</span> <span class="o">=</span> <span class="n">matched_idxs_in_image</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># 获取proposal匹配到的gt对应标签</span>
        <span class="n">labels_in_image</span> <span class="o">=</span> <span class="n">gt_labels_in_image</span><span class="p">[</span><span class="n">clamped_matched_idxs_in_image</span><span class="p">]</span>
        <span class="n">labels_in_image</span> <span class="o">=</span> <span class="n">labels_in_image</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># label background (below the low threshold)</span>
        <span class="c1"># 将gt索引为-1的类别设置为0，即背景，负样本</span>
        <span class="n">bg_inds</span> <span class="o">=</span> <span class="n">matched_idxs_in_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="o">.</span><span class="n">BELOW_LOW_THRESHOLD</span>  <span class="c1"># -1</span>
        <span class="n">labels_in_image</span><span class="p">[</span><span class="n">bg_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># label ignore proposals (between low and high threshold)</span>
        <span class="c1"># 将gt索引为-2的类别设置为-1, 即废弃样本</span>
        <span class="n">ignore_inds</span> <span class="o">=</span> <span class="n">matched_idxs_in_image</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal_matcher</span><span class="o">.</span><span class="n">BETWEEN_THRESHOLDS</span>  <span class="c1"># -2</span>
        <span class="n">labels_in_image</span><span class="p">[</span><span class="n">ignore_inds</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># -1 is ignored by sampler</span>

    <span class="n">matched_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clamped_matched_idxs_in_image</span><span class="p">)</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_in_image</span><span class="p">)</span>
</code></pre></div>
<h2 id="reference">Reference</h2>
<p><a href="https://pytorch.org/vision/stable/_modules/torchvision/models/detection/faster_rcnn.html">Official Pytorch Implemenation</a>,
<a href="https://github.com/jwyang/faster-rcnn.pytorch">A Faster Pytorch Implemenation of Faster-RCNN</a>,
<a href="https://github.com/WZMIAOMIAO/deep-learning-for-image-processing">Deep Learning for Image Processing</a></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../overview/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Overview
            </div>
          </div>
        </a>
      
      
        
        <a href="../yolo-series/" class="md-footer__link md-footer__link--next" aria-label="Next: YOLO-Series" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              YOLO-Series
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.960e086b.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.4.4/dist/mermaid.min.js"></script>
      
    
  </body>
</html>